#! /usr/bin/env node
var e=require("clear"),t=require("commander"),i=require("fs"),o=require("lolcatjs"),s=(require("clui"),require("configstore")),a=require("@octokit/rest"),n=require("inquirer"),r=require("https"),l=require("opn"),d=require("chalk"),c=require("clipboardy"),p=require("figlet");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var g=u(e),f=u(t),h=u(i),m=u(o),v=u(s),y=u(a),b=u(n),w=u(r),S=u(l),G=u(d),$=u(c),L=u(p),k="gisti",q="0.0.12";const I=()=>b.default.prompt([{name:"continueDelete",type:"confirm",message:"Are you sure you want to delete this gist?",default:!1}]),T=new v.default(k,{},{globalConfigPath:!0});var x=e=>{T.set("github.token",e),console.log("Token successfully saved")},C=()=>T.get("github.token");const P=(e,t)=>t.every((t=>e.match(new RegExp(t,"i")))),D=e=>{!!C()?e():(O(),console.log(G.default.red.bold("Set your personal github access token")),console.log("run "+G.default.rgb(0,160,200).bold("gisti --token <token>")))},O=()=>{m.default.fromString(L.default.textSync("GISTI",{font:"ANSI Shadow",horizontalLayout:"full"}))},j=(e,t)=>e?[t]:[],z=async e=>e.reduce(((e,t)=>[...e,...[{name:`${G.default.rgb(184,190,202).bold(t.id)} - ${t.description}`,value:t}]]),[]),Y=new v.default(k,{},{globalConfigPath:!0}).get("github.token"),_=new y.default({auth:Y}),F=(e,t)=>{switch(2*t+e){case 1:return E();case 2:return A();default:return M()}},M=async()=>{const{data:e}=await _.gists.list();return e},A=async()=>{const{data:e}=await _.gists.list();return e.filter((({public:e})=>!1===e))},E=async()=>{const{data:e}=await _.gists.listStarred();return e},U=e=>_.gists.get({gist_id:e}),N=e=>_.gists.delete({gist_id:e}),R=async e=>{const t=await(async e=>e.reduce(((e,t)=>{const i=Object.values(t.files);return[...e,new b.default.Separator(G.default.rgb(184,190,202).bold(`${t.description} - files: ${i.length}`)),...j(i.length>1,{name:G.default.rgb(0,160,200).bold(t.id),value:t}),...i.map((e=>({name:""+e.filename,value:{...e,gistId:t.id}})))]}),[]))(e);b.default.prompt([{type:"checkbox",message:"Choose gists or files to download",name:"gistsToDownload",pageSize:t.length,choices:t,validate:e=>!(e.length<1)||"You must choose at least one gist or file."}]).then((({gistsToDownload:e})=>{const t=[];for(const i of e)i.id&&t.push(K(i)),i.filename&&t.push(J(i));Promise.all(t).then((()=>console.log(G.default.green.bold("Download finished"))))}))},W=async e=>{const t=await z(e);b.default.prompt([{type:"list",message:"Select gist to open",name:"gistToOpen",pageSize:t.length,choices:t,validate:e=>!(e.length<1)||"You must choose at least one gist or file."}]).then((({gistToOpen:e})=>ee(e)))},B=async e=>{const t=await z(e);b.default.prompt([{type:"list",message:"Select gist to copy",name:"gistToCopy",pageSize:t.length,choices:t,validate:e=>!(e.length<1)||"You must choose at least one gist or file."}]).then((({gistToCopy:e})=>te(e)))},H=(e,t)=>{((e,t=!1)=>e.reduce(((e,i)=>{const o=Object.values(i.files);return[...e,G.default.rgb(184,190,202).bold(`${i.id} - ${i.description} - Files:${o.length}${i.public?"":G.default.rgb(236,98,113)(" [Private]")}`),...j(t,...o.map((e=>"- "+e.filename)))]}),[]))(e,t).forEach((e=>console.log(e)))},J=(e,t=process.cwd())=>{const i=e.gistId?`${e.gistId}_${e.filename}`:e.filename,o=h.default.createWriteStream(`${t}/${i}`);return new Promise((t=>w.default.get(e.raw_url,(s=>{s.pipe(o),console.log(G.default.green(i+" downloaded")),t(e)}))))},K=({id:e,files:t})=>{const i=`${process.cwd()}/${e}`;(e=>{h.default.existsSync(e)||h.default.mkdirSync(e)})(i);const o=Object.values(t),s=[];for(const e of o)s.push(J(e,i));return Promise.all(s)},Q=(e,t,i)=>{i(V(e,t))},V=(e,t)=>e.filter((({id:e,description:i})=>P(`${e} ${i}`,t.split(" ")))),X=async(e,t)=>{h.default.readFile(t,"utf8",(async(t,i)=>{const o=await(async e=>e.reduce(((e,t)=>{const i=Object.values(t.files);return[...e,new b.default.Separator(G.default.rgb(184,190,202).bold(`${t.id} - ${t.description}`)),...i.map((e=>({name:""+e.filename,value:{...e,gistId:t.id}})))]}),[]))(e);b.default.prompt([{type:"list",message:"Select gist to update",name:"gistToUpdate",pageSize:o.length>20?o.length:20,choices:o,validate:e=>1===e.length||"You must choose one file."}]).then((({gistToUpdate:e})=>Z(e,i)))}))},Z=({gistId:e,filename:t},i)=>{console.log(e,t,i)},ee=async({html_url:e})=>{S.default(e)},te=({id:e})=>{$.default.write(e)};m.default.options.seed=744;const ie=e=>e.reduce(((e,t)=>{const i=t.split("/");return{...e,[i[i.length-1]]:{content:h.default.readFileSync(t,"utf8")}}}),{});f.default.name("gisti").description("GISTI - The interactive CLI for gist").version(q),f.default.command("list").description("List your gists").option("-x, --private","List private Gists",!1).option("-s, --starred","List starred Gists",!1).option("-p, --public","List public Gists",!1).option("-f, --files","List files of Gist",!1).action((({starred:e,private:t,files:i})=>D((()=>{F(e,t).then((e=>{H(e,i)}))})))),f.default.command("copy").description("Copy the id of a gist to clipboard").option("-x, --private","List private Gists",!1).option("-s, --starred","List starred Gists",!1).option("-p, --public","List public Gists",!1).action((({starred:e,private:t})=>D((()=>{F(e,t).then((e=>{B(e)}))})))),f.default.command("open [id]").description("").option("--id <id>","Gist id for non-interactive update").option("-x, --private","List private Gists",!1).option("-s, --starred","List starred Gists",!1).option("-p, --public","List public Gists",!1).action(((e,{id:t,starred:i,private:o})=>D((()=>{F(i,o).then((i=>{(e=e||t)?(async e=>{const t=await U(e);ee(t),Promise.resolve()})(e):W(i)}))})))),f.default.command("create <files...>").description("").option("-x, --private","Create private Gist",!0).option("-p, --public","Create public Gists",!1).option("-d, --description <description>","Set the gist description").action(((e,{private:t,description:i})=>D((()=>{const o=ie(e);(e=>{_.gists.create(e)})({description:i,public:!t,files:o})})))),f.default.command("update [filePath] [id]").description("").option("-x, --private","Make Gist private",!1).option("-p, --public","List public Gists",!1).option("--id <id>","Gist id for non-interactive update").action(((e,t,{private:i,id:o})=>D((()=>{(t=t||o)?((e,t)=>{h.default.readFile(t,"utf8",(async(t,i)=>{const o=await U(e);Z(o,i)}))})(t,e):F(!1,i).then((t=>{X(t,e)})),console.log("file",e),console.log("Private",i),console.log("Id",t)})))),f.default.command("add  <files...>").description("").option("--id <id>","Gist id for non-interactive add").option("-d, --description <description>","Set the gist description").action(((e,{id:t})=>D((()=>{const i=ie(e);console.log(i),console.log("files",e),console.log("Id",t)})))),f.default.command("download [id]").description("").option("--id <id>","Gist id").option("-x, --private","Make Gist private",!1).option("-s, --starred","Search your starred gists",!1).option("-p, --public","List starred Gists",!1).action(((e,{private:t,id:i,starred:o})=>D((async()=>{if(e=e||i){const{data:t}=await U(e);K(t)}else F(o,t).then((e=>{R(e)}))})))),f.default.command("search [query]").description("").option("-l, --list","List search result").option("-c, --copy","Copy the id of one resulted gist").option("-o, --open","Open one resulted gist in browser").option("-d, --download","Download resulted gists").action(((e,{list:t,copy:i,open:o,download:s})=>D((()=>{const a=(({list:e,copy:t,open:i,download:o})=>o?R:e?H:t?B:i?W:H)({list:t,copy:i,open:o,download:s});(async e=>{const t=await M();return e?t.filter((({id:t,description:i})=>P(`${t} ${i}`,e.split(" ")))):t})(e).then((t=>{e?a(t):(async(e,t)=>{b.default.prompt([{name:"searchString",type:"input",message:"Search:",validate:e=>!!e.length||"Please enter a search"}]).then((({searchString:i})=>Q(e,i,t)))})(t,a)}))})))),f.default.command("delete [id]").description("").option("-x, --private","Make Gist private",!1).option("-p, --public","List starred Gists",!1).action(((e,{private:t,id:i,starred:o})=>D((()=>{(e=e||i)?I().then((({continueDelete:t})=>{t&&N(e)})):F(o,t).then((e=>{(async e=>{const t=await z(e);b.default.prompt([{type:"list",message:"Select gist to delete",name:"gistToDelete",pageSize:t.length,choices:t,validate:e=>1===e.length||"You must choose one gist."}]).then((({gistToDelete:{id:e}})=>{I().then((({continueDelete:t})=>{t&&N(e)}))}))})(e)}))})))),f.default.command("content [id] <files...>").description("stdout the gist content").option("--id <id>","Gist id").action(((e,t,{id:i})=>D((()=>{(e=e||i)&&console.log("Id",e)}))));var oe;g.default(),f.default.parse(process.argv),f.default.token&&(oe=()=>x(f.default.token),C()||oe());
